<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Analysis Scripts - Pellin Web Tool</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
        }

        .navbar {
            background: white;
            padding: 0;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .navbar-header {
            padding: 20px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #e5e7eb;
        }

        .navbar h1 {
            color: #2d3748;
            font-size: 24px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .back-btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
        }

        .back-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(59, 130, 246, 0.4);
        }

        .tabs-nav {
            display: flex;
            background: #f9fafb;
            border-bottom: 2px solid #e5e7eb;
        }

        .tab-nav {
            padding: 16px 32px;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            color: #6b7280;
            transition: all 0.3s ease;
        }

        .tab-nav:hover {
            color: #3b82f6;
            background: #f3f4f6;
        }

        .tab-nav.active {
            color: #1e3a8a;
            border-bottom-color: #3b82f6;
            background: white;
        }

        .container {
            max-width: 1400px;
            margin: 30px auto;
            padding: 0 40px;
        }

        .page-header {
            background: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .page-header h2 {
            color: #2d3748;
            font-size: 28px;
            margin-bottom: 10px;
        }

        .page-header p {
            color: #718096;
            font-size: 15px;
        }

        .script-section {
            background: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .script-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .script-section-title {
            color: #2d3748;
            font-size: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .script-section-title::before {
            content: "ðŸ“Š";
            font-size: 24px;
        }

        .script-description {
            color: #718096;
            font-size: 14px;
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .code-editor-wrapper {
            position: relative;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            overflow: hidden;
            background: #1e293b;
        }

        .code-editor-header {
            background: #0f172a;
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #334155;
        }

        .code-editor-header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .code-language {
            color: #94a3b8;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .code-editor-header-right {
            display: flex;
            gap: 8px;
        }

        .code-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .code-dot.red { background: #ef4444; }
        .code-dot.yellow { background: #f59e0b; }
        .code-dot.green { background: #10b981; }

        textarea.code-editor {
            width: 100%;
            min-height: 300px;
            padding: 20px;
            background: #1e293b;
            color: #e2e8f0;
            border: none;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', 'Consolas', 'source-code-pro', monospace;
            font-size: 14px;
            line-height: 1.6;
            resize: vertical;
            outline: none;
            tab-size: 4;
        }

        textarea.code-editor:focus {
            outline: none;
        }

        .script-actions {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 20px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-secondary {
            background: #e5e7eb;
            color: #374151;
        }

        .btn-secondary:hover {
            background: #d1d5db;
        }

        .btn-primary {
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(59, 130, 246, 0.4);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .submit-all-section {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            margin-top: 30px;
            text-align: center;
        }

        .submit-all-section h3 {
            color: #2d3748;
            font-size: 20px;
            margin-bottom: 15px;
        }

        .submit-all-section p {
            color: #718096;
            font-size: 14px;
            margin-bottom: 20px;
        }

        .btn-large {
            padding: 16px 40px;
            font-size: 16px;
        }

        .info-box {
            background: #eff6ff;
            border-left: 4px solid #3b82f6;
            padding: 15px 20px;
            border-radius: 6px;
            margin-bottom: 20px;
        }

        .info-box p {
            color: #1e40af;
            font-size: 14px;
            margin: 0;
        }
    </style>
</head>
<body>
    <div class="navbar">
        <div class="navbar-header">
            <h1>Analysis Scripts</h1>
            <div class="nav-buttons">
                <button class="back-btn" onclick="window.location.href='results.html'">Back to Results</button>
            </div>
        </div>
        <div class="tabs-nav">
            <button class="tab-nav" onclick="window.location.href='results.html'">Results</button>
            <button class="tab-nav active">Analysis Script</button>
        </div>
    </div>

    <div class="container">
        <!---
        <div class="page-header">
            <h2>Edit Analysis Scripts</h2>
            <p>Modify the scripts used to generate each visualization. Changes will be applied when you submit.</p>
        </div>

        <div class="info-box">
            <p>ðŸ’¡ <strong>Note:</strong> This is a mockup interface. Script modifications will be saved and reflected visually on the results page.</p>
        </div>
        --->

        <!-- Quality Score Distribution Script (R) -->
        <div class="script-section">
            <div class="script-section-header">
                <div class="script-section-title">Quality Score Distribution (R)</div>
            </div>
            <div class="script-description">
                R script for generating the quality score distribution chart showing R1 and R2 read quality across positions.
            </div>
            <div class="code-editor-wrapper">
                <div class="code-editor-header">
                    <div class="code-editor-header-left">
                        <span class="code-language">R</span>
                    </div>
                    <div class="code-editor-header-right">
                        <div class="code-dot red"></div>
                        <div class="code-dot yellow"></div>
                        <div class="code-dot green"></div>
                    </div>
                </div>
                <textarea class="code-editor" id="quality-script-r" spellcheck="false">draw_quality_chart <- function() {
            # Set up the canvas
            canvas_width <- 800
            canvas_height <- 400
            padding <- 40
            graph_width <- canvas_width - 2 * padding
            graph_height <- canvas_height - 2 * padding

            # Generate data
            positions <- 150
            r1_data <- 30 + runif(positions, 0, 8) + sin(seq(1, positions) / 20) * 2
            r2_data <- 28 + runif(positions, 0, 8) + sin(seq(1, positions) / 15) * 3

            # Create the plot
            plot(seq(1, positions), r1_data, type='l', col='#667eea', lwd=2, ylim=c(0, 40), 
                 xlab='Position', ylab='Quality Score', main='Quality Score Distribution', 
                 xaxt='n', yaxt='n')
            axis(1, at=seq(1, positions, by=10))
            axis(2, at=seq(0, 40, by=5))

            # Add R2 data
            lines(seq(1, positions), r2_data, col='#f6ad55', lwd=2)

            # Add grid
            grid()
        }

        # Call the function to draw the chart
        draw_quality_chart()</textarea>
            </div>
            <div class="script-actions">
                <button class="btn btn-secondary" onclick="DownloadScript('quality-script-r', 'quality_r')">Download</button>
                <button class="btn btn-secondary" onclick="scriptAdvanced()">Edit (Advanced)</button>
            </div>
        </div>

        <!-- Base Composition Script (Python) -->
        <div class="script-section">
            <div class="script-section-header">
            <div class="script-section-title">Base Composition Chart (Python)</div>
            </div>
            <div class="script-description">
            Python script for analyzing and generating a pie chart showing nucleotide composition (A, T, G, C percentages).
            </div>
            <div class="code-editor-wrapper">
            <div class="code-editor-header">
                <div class="code-editor-header-left">
                <span class="code-language">Python</span>
                </div>
                <div class="code-editor-header-right">
                <div class="code-dot red"></div>
                <div class="code-dot yellow"></div>
                <div class="code-dot green"></div>
                </div>
            </div>
            <textarea class="code-editor" id="base-script" spellcheck="false">import matplotlib.pyplot as plt
    from collections import Counter

    def analyze_base_composition(fastq_file):
        """
        Analyze base composition from FASTQ file
        """
        bases = {'A': 0, 'T': 0, 'G': 0, 'C': 0}
        
        with open(fastq_file, 'r') as f:
        lines = f.readlines()
        for i in range(1, len(lines), 4):
            sequence = lines[i].strip().upper()
            for base in sequence:
            if base in bases:
                bases[base] += 1
        
        return bases

    def plot_base_composition(fastq_file, output_file='base_composition.png'):
        """
        Generate pie chart of base composition
        """
        bases = analyze_base_composition(fastq_file)
        total = sum(bases.values())
        percentages = {base: (count / total) * 100 for base, count in bases.items()}
        
        fig, ax = plt.subplots(figsize=(10, 8))
        
        labels = list(percentages.keys())
        values = list(percentages.values())
        colors = ['#48bb78', '#f6ad55', '#667eea', '#ed64a6']
        
        wedges, texts, autotexts = ax.pie(values, labels=labels, autopct='%1.1f%%', 
                        colors=colors, startangle=90, textprops={'fontsize': 12})
        
        for autotext in autotexts:
        autotext.set_color('white')
        autotext.set_fontweight('bold')
        
        ax.set_title('Base Composition', fontsize=14, fontweight='bold')
        plt.tight_layout()
        plt.savefig(output_file, dpi=300)
        plt.close()

    if __name__ == '__main__':
        plot_base_composition('input.fastq')</textarea>
            </div>
            <div class="script-actions">
            <button class="btn btn-secondary" onclick="DownloadScript('base-script', 'base')">Download</button>
            <button class="btn btn-secondary" onclick="scriptAdvanced()">Edit (Advanced)</button>
            </div>
        </div>


        <!-- Read Length Distribution Script (Python) -->
        <div class="script-section">
            <div class="script-section-header">
            <div class="script-section-title">Read Length Distribution (Python)</div>
            </div>
            <div class="script-description">
            Python script for analyzing and generating the read length distribution histogram from sequencing data.
            </div>
            <div class="code-editor-wrapper">
            <div class="code-editor-header">
                <div class="code-editor-header-left">
                <span class="code-language">Python</span>
                </div>
                <div class="code-editor-header-right">
                <div class="code-dot red"></div>
                <div class="code-dot yellow"></div>
                <div class="code-dot green"></div>
                </div>
            </div>
            <textarea class="code-editor" id="read-length-python" spellcheck="false">import numpy as np
    import matplotlib.pyplot as plt
    from collections import Counter

    def analyze_read_lengths(fastq_file):
        """
        Analyze read length distribution from FASTQ file
        """
        read_lengths = []
        
        with open(fastq_file, 'r') as f:
        lines = f.readlines()
        for i in range(1, len(lines), 4):
            sequence = lines[i].strip()
            read_lengths.append(len(sequence))
        
        return read_lengths

    def plot_read_length_distribution(read_lengths, output_file='read_length_dist.png'):
        """
        Generate histogram of read length distribution
        """
        fig, ax = plt.subplots(figsize=(12, 6))
        
        ax.hist(read_lengths, bins=50, color='#667eea', edgecolor='#764ba2', alpha=0.7)
        ax.set_xlabel('Read Length (bp)', fontsize=12)
        ax.set_ylabel('Frequency', fontsize=12)
        ax.set_title('Read Length Distribution', fontsize=14, fontweight='bold')
        ax.grid(axis='y', alpha=0.3)
        
        stats_text = f"Mean: {np.mean(read_lengths):.0f} bp\nMedian: {np.median(read_lengths):.0f} bp\nStdDev: {np.std(read_lengths):.0f} bp"
        ax.text(0.98, 0.97, stats_text, transform=ax.transAxes, verticalalignment='top', 
            horizontalalignment='right', bbox=dict(boxstyle='round', facecolor='wheat', alpha=0.5))
        
        plt.tight_layout()
        plt.savefig(output_file, dpi=300)
        plt.close()

    if __name__ == '__main__':
        read_lengths = analyze_read_lengths('input.fastq')
        plot_read_length_distribution(read_lengths)</textarea>
            </div>
            <div class="script-actions">
            <button class="btn btn-secondary" onclick="DownloadScript('read-length-python', 'read_length_analysis')">Download</button>
            <button class="btn btn-secondary" onclick="scriptAdvanced()">Edit (Advanced)</button>
            </div>
        </div>

        <!-- Volcano Plot Script (Python) -->
        <div class="script-section">
            <div class="script-section-header">
            <div class="script-section-title">Volcano Plot - Differential Expression (Python)</div>
            </div>
            <div class="script-description">
            Python script for generating volcano plots showing differentially expressed genes with log2 fold change and adjusted p-values.
            </div>
            <div class="code-editor-wrapper">
            <div class="code-editor-header">
                <div class="code-editor-header-left">
                <span class="code-language">Python</span>
                </div>
                <div class="code-editor-header-right">
                <div class="code-dot red"></div>
                <div class="code-dot yellow"></div>
                <div class="code-dot green"></div>
                </div>
            </div>
            <textarea class="code-editor" id="volcano-script" spellcheck="false">import pandas as pd
    import numpy as np
    import matplotlib.pyplot as plt
    from scipy import stats

    def perform_differential_expression(counts_file, metadata_file):
        """
        Perform differential expression analysis
        """
        counts = pd.read_csv(counts_file, index_col=0)
        metadata = pd.read_csv(metadata_file, index_col=0)
        
        # Separate groups
        control = counts[metadata['condition'] == 'control'].values
        treatment = counts[metadata['condition'] == 'treatment'].values
        
        results = []
        for gene in counts.index:
        gene_idx = counts.index.get_loc(gene)
        ctrl_expr = control[:, gene_idx]
        treat_expr = treatment[:, gene_idx]
        
        # Calculate log2 fold change
        log2fc = np.log2(treat_expr.mean() + 1) - np.log2(ctrl_expr.mean() + 1)
        
        # T-test p-value
        t_stat, p_val = stats.ttest_ind(treat_expr, ctrl_expr)
        neg_log10_p = -np.log10(p_val) if p_val > 0 else 10
        
        results.append({
            'gene': gene,
            'log2fc': log2fc,
            'p_value': p_val,
            'neg_log10_p': neg_log10_p
        })
        
        return pd.DataFrame(results)

    def plot_volcano(de_results, output_file='volcano_plot.png', fc_threshold=1, p_threshold=0.05):
        """
        Generate volcano plot
        """
        fig, ax = plt.subplots(figsize=(10, 8))
        
        neg_log10_p_threshold = -np.log10(p_threshold)
        
        colors = []
        for _, row in de_results.iterrows():
        if abs(row['log2fc']) > fc_threshold and row['neg_log10_p'] > neg_log10_p_threshold:
            colors.append('#e53e3e' if row['log2fc'] > 0 else '#3182ce')
        else:
            colors.append('#a0aec0')
        
        ax.scatter(de_results['log2fc'], de_results['neg_log10_p'], c=colors, alpha=0.6, s=50)
        
        ax.axvline(-fc_threshold, color='gray', linestyle='--', alpha=0.5)
        ax.axvline(fc_threshold, color='gray', linestyle='--', alpha=0.5)
        ax.axhline(neg_log10_p_threshold, color='gray', linestyle='--', alpha=0.5)
        
        ax.set_xlabel('log2(Fold Change)', fontsize=12)
        ax.set_ylabel('-log10(p-value)', fontsize=12)
        ax.set_title('Volcano Plot - Differential Expression', fontsize=14, fontweight='bold')
        ax.grid(axis='both', alpha=0.3)
        
        plt.tight_layout()
        plt.savefig(output_file, dpi=300)
        plt.close()

    if __name__ == '__main__':
        de_results = perform_differential_expression('counts.csv', 'metadata.csv')
        plot_volcano(de_results)</textarea>
            </div>
            <div class="script-actions">
            <button class="btn btn-secondary" onclick="DownloadScript('volcano-script', 'volcano')">Download</button>
            <button class="btn btn-secondary" onclick="scriptAdvanced()">Edit (Advanced)</button>
            </div>
        </div>

        <div class="submit-all-section">
            <h3>Download All Scripts</h3>
            <button class="btn btn-primary btn-large" onclick="submitScripts()">Download ALL</button>
        </div>
    </div>

    <script>
        function DownloadScript(textareaId, scriptKey) {
            const textarea = document.getElementById(textareaId);
            const scriptName = scriptKey.charAt(0).toUpperCase() + scriptKey.slice(1);
            const element = document.createElement('a');
            element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(textarea.value));
            element.setAttribute('download', `${scriptKey}-script.py`);
            element.style.display = 'none';
            document.body.appendChild(element);
            element.click();
            document.body.removeChild(element);
        }

        function submitScripts() {
            const scripts = {
                quality: document.getElementById('quality-script').value,
                base: document.getElementById('base-script').value,
                length: document.getElementById('length-script').value,
                volcano: document.getElementById('volcano-script').value
            };

            // Create a zip file or download all scripts
            const scriptNames = ['quality', 'base', 'length', 'volcano'];
            scriptNames.forEach(scriptKey => {
                const element = document.createElement('a');
                element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(scripts[scriptKey]));
                element.setAttribute('download', `${scriptKey}-script.js`);
                element.style.display = 'none';
                document.body.appendChild(element);
                element.click();
                document.body.removeChild(element);
            });

            // Show confirmation
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = 'âœ“ Download Started!';
            btn.style.background = '#10b981';
            btn.disabled = true;

            setTimeout(() => {
                btn.textContent = originalText;
                btn.style.background = '';
                btn.disabled = false;
            }, 2000);
        }
    </script>
</body>
</html>
